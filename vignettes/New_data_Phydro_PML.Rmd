

```{r setup, include = FALSE}
# Install packages
# if ("rsofun" %in% installed.packages()) remove.packages("rsofun")
devtools::install_github(
  "geco-bern/rsofun@phydro",
  upgrade = "never",
  force = TRUE
  )
# Load packages
library(rsofun)
packageVersion("rsofun")
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(lubridate)
library(knitr)
library(ggthemes)
library(here)

# Load functions
source("../R/eval_sofun.R")
source("../R/get_stats.R")
source("../R/analyse_modobs2.R")
source(here("R/align_events.R"))
source(here("R/eval_droughtresponse.R"))
source(here("R/heatscatter_dependencies.R"))


# Set seed
set.seed(42)

# model forcing data
driver <- read_rds("/data_2/FluxDataKit/v3.4/zenodo_upload/rsofun_driver_data_v3.4.rds") # currently only on workstation

# site meta info

fdk_site_info <- read_csv("/data_2/FluxDataKit/v3.4/zenodo_upload/fdk_site_info.csv")

fdk_filter <-  read_csv("/data_2/FluxDataKit/v3.4/zenodo_upload/fdk_site_fullyearsequence.csv")


fdk_site_info <- fdk_site_info[fdk_site_info$igbp_land_use != "CRO" &
                               fdk_site_info$igbp_land_use != "WET" 
                               # &
                               # fdk_site_info$sitename != "CA-SF1" &
                               # fdk_site_info$sitename != "CA-SF3" &
                               # fdk_site_info$sitename != "GF-Guy" &
                               # fdk_site_info$sitename != "ID-Pag" &
                               # fdk_site_info$sitename != "US-HWB" & 
                               # fdk_site_info$sitename != "GL-Dsk"
                               ,]

fdk_filter <- fdk_filter[fdk_filter$drop_gpp == "FALSE",]

driver <-driver[which(driver$sitename %in% fdk_site_info$sitename & 
                      driver$sitename %in% fdk_filter$sitename),]

fdk_site_info <-fdk_site_info[which(fdk_site_info$sitename %in% driver$sitename),]

fdk_filter <-fdk_filter[which(fdk_filter$sitename %in% driver$sitename &
                              fdk_filter$sitename %in% fdk_site_info$sitename),]

# select only year with good quality le

driver <- left_join(
  driver, fdk_filter |>
  select(sitename,year_start_gpp,year_end_gpp),
  by = "sitename") |>
  unnest(forcing) |>
  filter(between(as_date(date),
                 as_date(paste0(year_start_gpp,"-01-01")),
                 as_date(paste0(year_end_gpp,"-12-31"))
                 )
         ) |>
  group_by(sitename) |>
  nest(data = colnames(driver[1,]$forcing[[1]])) |>
  rename(forcing = data) |>
  select(-c(year_start_gpp,year_end_gpp))


# site selection: good-quality sites from analysis of Stocker et al. (2018) New Phyt.
df_flue <- readr::read_csv(here("data/flue_stocker18nphyt.csv"))

df_flue <- df_flue[df_flue$site %in% fdk_filter$sitename,]

df_flue <- left_join(df_flue |>
                       rename(sitename = site), fdk_filter |>
                       select(sitename,year_start_gpp,year_end_gpp),
                       by = "sitename") |>
           filter(between(as_date(date),
                 as_date(paste0(year_start_gpp,"-01-01")),
                 as_date(paste0(year_end_gpp,"-12-31"))
                 )) |>
           select(-c(year_start_gpp,year_end_gpp)) |>
           rename(site = sitename)



# observational data as calibration and evaluation target
# created from daily FLUXNE2015 data by:
# - using GPP_NT_VUT_REF
# - using QC>0.8
# changing the obs val to the new version with gpp

load(here("data/obs_eval_fluxnet2015.Rdata"), verbose = TRUE) # use as a blueprint
obs_eval$ddf <- NULL
obs_eval$xdf <- NULL
obs_eval$mdf <- NULL
obs_eval$adf <- NULL
obs_eval$breaks <- NULL


# daily data

ddf_tibble_preparation <- driver |>
  unnest(forcing) |>
  group_by(sitename) |>
  select(date,gpp) |>
  nest()

ddf_tibble_preparation <- ddf_tibble_preparation$data

obs_eval$ddf <- tibble(sitename = fdk_site_info$sitename,
                       lon = fdk_site_info$lon,
                       lat = fdk_site_info$lat,
                       elv = fdk_site_info$elv,
                       classid = fdk_site_info$igbp_land_use,
                       whc = fdk_site_info$whc,
                       koeppen_code = fdk_site_info$koeppen_code,
                       igbp_land_use = fdk_site_info$igbp_land_use,
                       plant_functioanl_type= NA,
                       c4 = FALSE,
                       data = ddf_tibble_preparation)

# weekly data

xdf_tibble_preparation <- driver |>
  unnest(forcing) |>
  mutate(week = lubridate::floor_date(date, "week")) |>
  select(sitename ,week,gpp) |>
  group_by(sitename, week) |>
  summarize(gpp = sum(gpp)) |>
  mutate(inbin = as.factor(week), date = week) |>
  select(date,inbin,gpp) |>
  nest()

xdf_tibble_preparation <- xdf_tibble_preparation$data

obs_eval$xdf <- tibble(sitename = fdk_site_info$sitename,
                       lon = fdk_site_info$lon,
                       lat = fdk_site_info$lat,
                       elv = fdk_site_info$elv,
                       classid = fdk_site_info$igbp_land_use,
                       whc = fdk_site_info$whc,
                       koeppen_code = fdk_site_info$koeppen_code,
                       igbp_land_use = fdk_site_info$igbp_land_use,
                       plant_functioanl_type= NA,
                       c4 = FALSE,
                       data = xdf_tibble_preparation)

# monthly data

mdf_tibble_preparation <- driver |>
  unnest(forcing) |>
  mutate(month = lubridate::floor_date(date, "month")) |>
  select(sitename ,month,gpp) |>
  group_by(sitename, month) |>
  summarize(gpp = sum(gpp)) |>
  mutate(date = month) |>
  select(date,gpp) |>
  nest()

mdf_tibble_preparation <- mdf_tibble_preparation$data

obs_eval$mdf <- tibble(sitename = fdk_site_info$sitename,
                       lon = fdk_site_info$lon,
                       lat = fdk_site_info$lat,
                       elv = fdk_site_info$elv,
                       classid = fdk_site_info$igbp_land_use,
                       whc = fdk_site_info$whc,
                       koeppen_code = fdk_site_info$koeppen_code,
                       igbp_land_use = fdk_site_info$igbp_land_use,
                       plant_functioanl_type= NA,
                       c4 = FALSE,
                       data = mdf_tibble_preparation)

# annual data

adf_tibble_preparation <- driver |>
  unnest(forcing) |>
  mutate(year = lubridate::floor_date(date, "year")) |>
  select(sitename ,year,gpp) |>
  group_by(sitename, year) |>
  summarize(gpp = sum(gpp)) |>
  mutate(date = year) |>
  select(date,gpp) |>
  nest()

adf_tibble_preparation <- adf_tibble_preparation$data

obs_eval$adf <- tibble(sitename = fdk_site_info$sitename,
                       lon = fdk_site_info$lon,
                       lat = fdk_site_info$lat,
                       elv = fdk_site_info$elv,
                       classid = fdk_site_info$igbp_land_use,
                       whc = fdk_site_info$whc,
                       koeppen_code = fdk_site_info$koeppen_code,
                       igbp_land_use = fdk_site_info$igbp_land_use,
                       plant_functioanl_type= NA,
                       c4 = FALSE,
                       data = adf_tibble_preparation)


breaks_preparation <- driver |>
  unnest(forcing) |>
  select(date) |>
  arrange(date) |>
  distinct(date) |>
  mutate(breaks = lubridate::floor_date(date, "week"))


obs_eval$breaks <- unique((breaks_preparation$breaks))[-1]

```

# Model run

```{r warning = FALSE, message = FALSE}
par_calib <-  read_rds(here("data","calibration_new_data_phydro_25.rds"))

output <- NULL

for(i in 1:dim(driver[1])){
  
  driver$params_siml[[i]]$use_gs     <- TRUE
  driver$params_siml[[i]]$use_pml    <- TRUE
  driver$params_siml[[i]]$use_phydro <- FALSE
  
  driver$forcing_acclim[[i]] <- driver$forcing[[i]]

  driver$site_info[[i]]$canopy_height    <- fdk_site_info$canopy_height[i]
  driver$site_info[[i]]$reference_height <- fdk_site_info$reference_height[i]
  
  params_modl <- list(
    kphio              = par_calib$par[["kphio"]],   
    kphio_par_a        = par_calib$par[["kphio_par_a"]],       
    kphio_par_b        = par_calib$par[["kphio_par_b"]],
    rd_to_vcmax        = 0.014,  
    soilm_thetastar    = par_calib$par[["soilm_thetastar"]], 
    beta_unitcostratio = 146,
    tau_acclim         = 30,
    kc_jmax            = 0.54131889
  )
  
  
 tmp <- rsofun::runread_pmodel_f(
  driver[i,],
  par = params_modl
 )
  
  
  output <- rbind(output,tmp)

}

# TODO: some sites do not work here:
output |>
  mutate(len = purrr::map_int(data, ~nrow(.))) |>
  filter(len == 1) |>
  select(-len)
#   sitename site_info        data             
#   <chr>    <list>           <list>           
# 1 FR-Hes   <tibble [1 × 4]> <tibble [1 × 24]>
# 2 SE-Nor   <tibble [1 × 4]> <tibble [1 × 24]>

# remove sites where it didn't work
output <- output |>
  mutate(len = purrr::map_int(data, ~nrow(.))) |>
  filter(!(sitename %in% c("CH-Cha", "CH-Dav", "IT-Tor", "CZ-Lnz","FR-FBn", "GL-Dsk", "IT-Lav"))) |>
  filter(len != 1) |>
  select(-len)
```

# Run evaluation

This runs the `eval_sofun()` routine included in the sofunCalVal package, and outputs daily, monthly and annual summary statistics comparing observed with simulated values. We'll retake this same routine when running on the latest release (i.e. the workflow is equivalent but for the release of the `rsofun` package)

```{r warning=FALSE, message=FALSE, error=FALSE, include = FALSE}
train_site_phydro_25 <- readRDS(here("data/train_site_phydro_25.rds"))

evalsites <- output$sitename[!(output$sitename %in% train_site_phydro_25 )]

# write_rds(evalsites, file = here("data/evalsites.rds"))

settings_eval <- list(
  benchmark = list( gpp = c("fluxnet") ),
  sitenames = evalsites,
  agg       = 8
  )

out_eval <- eval_sofun( 
  output, 
  settings_eval, 
  obs_eval = obs_eval, 
  overwrite = TRUE, 
  light = FALSE 
  )
```

# Results

```{r warning=FALSE, message=FALSE, error=FALSE, echo = FALSE}
out_eval$gpp$fluxnet$metrics %>% 
  bind_rows(.id = "Level") %>% 
  kable()
```

## 8-daily, spatial and annual

```{r message = FALSE, warning = FALSE, echo = FALSE}
out_eval$gpp$fluxnet$plot$gg_modobs_xdaily
out_eval$gpp$fluxnet$plot$gg_modobs_spatial_annual
```

## Mean seasonal cycle

```{r message = FALSE, warning = FALSE, echo = FALSE}
out_eval$gpp$fluxnet$data$meandoydf_byclim %>% 
  dplyr::filter(climatezone %in% c(
    "Aw south", "BSk north", "Cfa north",
    "Cfb north", "Cfb south", "Csa north",
    "Csb north", "Dfb north", "Dfc north")
    ) %>%
  dplyr::filter(koeppen_code != "-") %>% 
  pivot_longer(
    c(obs_mean, mod_mean),
    names_to = "source",
    values_to = "gpp"
    ) %>% 
  ggplot() +
  geom_ribbon(
    aes(x = doy, ymin = obs_min, ymax = obs_max), 
    fill = "black", 
    alpha = 0.2
    ) +
  geom_line(aes(x = doy, y = gpp, color = source), size = 0.4) +
  labs(y = expression( paste("Simulated GPP (g C m"^-2, " d"^-1, ")" ) ), 
       x = "DOY") +
  facet_wrap( ~climatezone ) +
  theme_gray() +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Setup: ",
    values = c("red", "black")
    )
```

## Drought response

```{r message = FALSE, warning = FALSE, echo = FALSE}
source("R/align_events.R")
source("R/eval_droughtresponse.R")

df_dday_agg <- eval_droughtresponse( 
  df = out_eval$gpp$fluxnet$data$ddf %>%
    rename(
      site = sitename
      ), 
  df_flue = readr::read_csv(here::here("data/flue_stocker18nphyt.csv")),
  before = 20,
  after = 105,
  leng_threshold = 10, 
  nbins = 10, 
  do_norm = TRUE
  )

df_dday_agg %>% 
  ggplot() +
  geom_hline(
    yintercept = 0,
    color = "black",
    linetype = "dotted"
    ) +
  geom_vline(
    xintercept = 0,
    color = "black",
    linetype = "dotted"
    ) +
  geom_line(
    aes(
      x = dday,
      y = median
      ),
    size = 0.9) +
  geom_ribbon(
    aes(
      x = dday,
      ymin = q33,
      ymax = q66
      ), 
    alpha = 0.3) +
  scale_color_manual(
    values = c(
      "BRC" = "black",
      "FULL" = "royalblue"
      ),
    name = "Setup"
    ) +
  scale_fill_manual(
    values = c(
      "BRC" = "black",
      "FULL" = "royalblue"
      ),
    name = "Setup") +
  ylim(-1.2, 2.2) + 
  xlim(-20, 105) +
  scale_x_continuous(
    expand = c(0,0)
    ) +
  scale_y_continuous(
    expand = c(0,0)
    ) +
  labs(
    x = "Days after drought onset",
    y = expression( paste( "Bias (g C m"^{-1}, " d"^{-1}, ")")) 
    ) +
  theme_classic() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_line()
  )
```

## Appendix

```{r}
sessionInfo()
```

